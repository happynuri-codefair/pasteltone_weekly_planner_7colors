<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>파스텔톤 주간 플래너</title>

  <style>
    :root{
      --bg:#fff4f8;
      --border:#f2c7d6;
      --header:#ffe0eb;
      --timebg:#ffedf4;
      --text:#111;
      --focus: color-mix(in srgb, var(--border) 70%, #000 30%);
      --card: color-mix(in srgb, var(--bg) 75%, #fff 25%);
      --paper: portrait; /* portrait | landscape */
      --cornerLine: #e25a6a; /* 대각선 색(예시처럼 붉게) */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Malgun Gothic", Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
    }

    /* ===== 앱바 ===== */
    .appbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 78%, white 22%);
      border-bottom: 1px solid var(--border);
    }
    .appbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      min-width: 240px;
    }
    .title{
      font-weight: 1000;
      font-size: 16px;
      letter-spacing: -0.2px;
      white-space: nowrap;
    }
    .hint{
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
    }

    .right{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .btn, .select, .input{
      border: 1px solid var(--border);
      background: white;
      padding: 7px 10px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 13px;
      opacity: .97;
    }
    .btn{ cursor:pointer; user-select:none; }
    .btn:hover{ opacity: 1; }
    .btn.ghost{
      background: transparent;
      border: 1px dashed var(--border);
    }
    .select{ padding: 7px 10px; }
    .input{ padding: 7px 10px; min-width: 240px; font-weight: 900; }

    /* ===== 예쁜 토글 스위치 ===== */
    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, white 70%, var(--bg) 30%);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
      cursor:pointer;
    }
    .switch input{ display:none; }
    .track{
      width: 38px; height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      position: relative;
      flex: 0 0 auto;
    }
    .knob{
      width: 18px; height: 18px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--border) 55%, #fff 45%);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .18s ease, background .18s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .switch.on .track{
      background: color-mix(in srgb, var(--header) 65%, #fff 35%);
    }
    .switch.on .knob{
      left: 19px;
      background: color-mix(in srgb, var(--border) 85%, #fff 15%);
    }

    .theme-bar{
      display:flex;
      flex-wrap: wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .theme-btn{
      border: 1px solid var(--border);
      background: white;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
      opacity: 0.92;
      user-select:none;
    }
    .theme-btn.active{
      outline: 2px solid var(--border);
      opacity: 1;
    }

    /* ===== 본문 ===== */
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 12px 30px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    /* 제목 영역(토글로 숨김/표시) */
    .title-area{
      display:none;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .title-area.show{ display:flex; }
    .planner-title{
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: -0.2px;
    }
    .meta{
      font-size: 12px;
      opacity: .75;
      font-weight: 900;
    }

    /* 테이블 가로 스크롤(모바일) */
    .table-wrap{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      background: #fff;
    }

    .planner{
      width: 100%;
      min-width: 860px;
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .planner th, .planner td{
      border: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
      height: 36px;
      padding: 6px 6px;
      font-size: 14px;
    }

    /* 헤더 sticky */
    .planner thead th{
      background: var(--header);
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    /* 시간열 sticky */
    .planner td.time{
      background: var(--timebg);
      font-weight: 900;
      position: sticky;
      left: 0;
      z-index: 4;
      width: 110px;
    }

    /* 좌상단 대각선 셀 - SVG로 정확히 */
    .planner th.corner{
      position: sticky;
      top: 0;
      left: 0;
      z-index: 6;
      width: 110px;
      min-width: 110px;
      padding: 0;
      background: var(--header);
    }
    .cornerBox{
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 44px;
    }
    .cornerSvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .cornerTime{
      position:absolute;
      left: 10px;
      top: 18px;
      font-weight: 1000;
      font-size: 13px;
    }
    .cornerDay{
      position:absolute;
      right: 10px;
      top: 6px;
      font-weight: 1000;
      font-size: 13px;
    }

    /* 요일 헤더에 날짜 표시 */
    .dow{
      display:flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.05;
      align-items:center;
      justify-content:center;
    }
    .dow .name{ font-weight: 1000; }
    .dow .date{
      font-size: 11px;
      opacity: .7;
      font-weight: 900;
      min-height: 12px;
    }

    /* 클릭 셀 */
    .planner td.cell{
      cursor: pointer;
      text-align: left;
      padding: 6px 8px;
      white-space: pre-wrap;
      word-break: break-word;
      background: #fff;
    }
    .planner td.cell:hover{
      background: color-mix(in srgb, var(--header) 18%, white 82%);
    }
    .planner td.cell.empty::before{
      content: "클릭해서 입력";
      opacity: .25;
    }
    .planner td.cell .preview{
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* 모바일 */
    @media (max-width: 520px){
      .hint{ display:none; }
      .input{ min-width: 160px; }
      .planner th, .planner td{ font-size: 13px; height: 34px; }
      .btn, .select{ font-size: 12px; }
      .switch{ font-size: 12px; }
    }

    /* ===== 메모장 모달 ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 100;
      padding: 14px;
    }
    .modal{
      width: min(720px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .modal-header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--bg) 75%, #fff 25%);
      border-bottom: 1px solid var(--border);
    }
    .modal-title{
      font-weight: 1000;
      font-size: 14px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
      font-weight: 1000;
      opacity: .92;
    }
    .modal-body{
      padding: 10px 12px 12px;
    }
    textarea{
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
    }
    textarea:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--border) 50%, transparent 50%);
      border-color: var(--focus);
    }
    .modal-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* ===== 날짜 설정 영역 ===== */
    .date-tools{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      margin: 8px 0 0;
    }
    .date-tools.show{ display:flex; }
    .date-tools .mini{
      font-size: 12px;
      font-weight: 900;
      opacity: .75;
    }

    /* ===== 인쇄 ===== */
    @media print{
      body{
        background:#fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      /* 세로 잘림 방지: margin을 조금 더 줄임 */
      @page{
        size: A4 var(--paper);
        margin: 10mm;
      }
      .appbar{ display:none; }
      .wrap{ max-width:none; padding:0; }
      .card{
        border: none;
        background:#fff;
        padding:0;
      }
      .table-wrap{ overflow: visible; }
      .planner{
        min-width: auto;
        border-radius: 0;
      }
      /* 인쇄에서 sticky가 이상하게 보일 수 있어서 해제 */
      .planner thead th,
      .planner td.time,
      .planner th.corner{
        position: static !important;
      }
      .planner td.cell.empty::before{ content:""; }
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="left">
        <div class="title">파스텔톤 주간 플래너</div>
        <div class="hint">칸 클릭 → 메모장 입력 · 자동저장</div>

        <!-- 날짜 연동 토글(예쁘게) -->
        <label class="switch" id="dateSwitch" title="날짜 연동을 켜면 주를 선택하고 요일 옆에 날짜가 표시돼.">
          <span class="track"><span class="knob"></span></span>
          <span>날짜 연동</span>
          <input type="checkbox" id="dateLinkToggle" />
        </label>

        <!-- 제목 표시 토글 -->
        <label class="switch" id="titleSwitch" title="제목을 보이게/숨기기">
          <span class="track"><span class="knob"></span></span>
          <span>제목 표시</span>
          <input type="checkbox" id="titleToggle" />
        </label>
      </div>

      <div class="right">
        <button class="btn" id="noticeBtn" type="button">공지</button>

        <select class="select" id="orientationSelect" title="인쇄 방향 선택">
          <option value="portrait">세로(A4)</option>
          <option value="landscape">가로(A4)</option>
        </select>

        <button class="btn" id="printBtn" type="button">인쇄</button>
        <button class="btn" id="exportBtn" type="button">내보내기</button>
        <button class="btn" id="importBtn" type="button">가져오기</button>
        <button class="btn ghost" id="clearBtn" type="button">현재 테마 지우기</button>

        <div class="theme-bar" id="themeBar"></div>
      </div>
    </div>

    <!-- 날짜 연동 켜졌을 때 나오는 툴 -->
    <div class="appbar-inner" style="padding-top:0;">
      <div class="date-tools" id="dateTools">
        <span class="mini">주 선택:</span>
        <input class="select" id="weekPicker" type="week" />
        <span class="mini">또는 기준 날짜:</span>
        <input class="select" id="datePicker" type="date" />
        <span class="mini" id="weekRangeText"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <!-- 제목 영역 -->
      <div class="title-area" id="titleArea">
        <div>
          <div class="planner-title" id="plannerTitleText">주간 플래너</div>
          <div class="meta" id="plannerMetaText"></div>
        </div>
        <input class="input" id="titleInput" placeholder="제목 변경 가능" />
      </div>

      <div class="table-wrap">
        <table class="planner" aria-label="주간 플래너">
          <thead>
            <tr>
              <th class="corner">
                <div class="cornerBox">
                  <!-- 예시처럼 굵은 대각선 -->
                  <svg class="cornerSvg" viewBox="0 0 110 44" preserveAspectRatio="none" aria-hidden="true">
                    <line x1="0" y1="0" x2="110" y2="44" stroke="var(--cornerLine)" stroke-width="6" />
                  </svg>
                  <div class="cornerDay">요일</div>
                  <div class="cornerTime">시간</div>
                </div>
              </th>
              <th><div class="dow"><div class="name">월</div><div class="date" data-dow="0"></div></div></th>
              <th><div class="dow"><div class="name">화</div><div class="date" data-dow="1"></div></div></th>
              <th><div class="dow"><div class="name">수</div><div class="date" data-dow="2"></div></div></th>
              <th><div class="dow"><div class="name">목</div><div class="date" data-dow="3"></div></div></th>
              <th><div class="dow"><div class="name">금</div><div class="date" data-dow="4"></div></div></th>
              <th><div class="dow"><div class="name">토</div><div class="date" data-dow="5"></div></div></th>
              <th><div class="dow"><div class="name">일</div><div class="date" data-dow="6"></div></div></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- 메모장 모달 -->
  <div class="modal-backdrop" id="memoBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="pill" id="pillTime">--:--</span>
          <span class="pill" id="pillDay">요일</span>
        </div>
        <button class="btn" id="closeMemo" type="button">닫기</button>
      </div>
      <div class="modal-body">
        <textarea id="memoText" placeholder="여기에 내용을 입력해줘. (자동저장)"></textarea>
        <div class="modal-actions">
          <button class="btn ghost" id="clearCellBtn" type="button">이 칸 비우기</button>
          <button class="btn" id="saveMemo" type="button">저장</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 가져오기용 파일 인풋(숨김) -->
  <input id="importFile" type="file" accept="application/json" style="display:none;" />

  <script>
    // ===== 기본 데이터 =====
    const times = [
      "06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00",
      "16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","00:00","01:00"
    ];
    const days = ["월","화","수","목","금","토","일"];

    // ===== 테마 =====
    const THEMES = [
      { key:"pink",  name:"분홍",   bg:"#fff4f8", border:"#f2c7d6", header:"#ffe0eb", timebg:"#ffedf4" },
      { key:"peach", name:"연주황", bg:"#fff6f0", border:"#f3d2bf", header:"#ffe6d8", timebg:"#fff1e8" },
      { key:"yellow",name:"연노랑", bg:"#fffce8", border:"#efe0a8", header:"#fff3c9", timebg:"#fff8dd" },
      { key:"mint",  name:"민트",   bg:"#f1fffb", border:"#bfe6da", header:"#d7fff3", timebg:"#eafff8" },
      { key:"periw", name:"라이트 블루 바이올렛", bg:"#f3f5ff", border:"#c8cef2", header:"#e1e6ff", timebg:"#eef0ff" },
      { key:"lav",   name:"연보라", bg:"#faf4ff", border:"#dcc7f0", header:"#efe3ff", timebg:"#f6efff" },
      { key:"ivory", name:"아이보리", bg:"#fffdf4", border:"#e7dfc9", header:"#f7f0da", timebg:"#fff8e8" },
    ];

    // ===== storage keys =====
    const STORAGE_THEME_KEY = "planner_theme";
    const STORAGE_TITLE_KEY = "planner_custom_title";
    const STORAGE_TITLE_SHOW_KEY = "planner_title_show";
    const STORAGE_DATE_LINK_KEY = "planner_date_link_enabled";
    const STORAGE_WEEK_KEY = "planner_selected_week"; // 2026-W05
    const STORAGE_ORIENTATION_KEY = "planner_print_orientation";

    const dataKey = (themeKey) => `planner_data_${themeKey}`;

    let currentThemeKey = localStorage.getItem(STORAGE_THEME_KEY) || "pink";

    // ===== DOM =====
    const rowsEl = document.getElementById("rows");
    const themeBar = document.getElementById("themeBar");

    // switches
    const dateLinkToggle = document.getElementById("dateLinkToggle");
    const dateSwitch = document.getElementById("dateSwitch");
    const titleToggle = document.getElementById("titleToggle");
    const titleSwitch = document.getElementById("titleSwitch");

    // date tools
    const dateTools = document.getElementById("dateTools");
    const weekPicker = document.getElementById("weekPicker");
    const datePicker = document.getElementById("datePicker");
    const weekRangeText = document.getElementById("weekRangeText");

    // title area
    const titleArea = document.getElementById("titleArea");
    const plannerTitleText = document.getElementById("plannerTitleText");
    const plannerMetaText = document.getElementById("plannerMetaText");
    const titleInput = document.getElementById("titleInput");

    // modal
    const memoBackdrop = document.getElementById("memoBackdrop");
    const memoText = document.getElementById("memoText");
    const pillTime = document.getElementById("pillTime");
    const pillDay = document.getElementById("pillDay");
    const closeMemo = document.getElementById("closeMemo");
    const saveMemoBtn = document.getElementById("saveMemo");
    const clearCellBtn = document.getElementById("clearCellBtn");

    // import/export
    const importBtn = document.getElementById("importBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importFile = document.getElementById("importFile");

    // print
    const orientationSelect = document.getElementById("orientationSelect");

    let activeCell = null; // {r,c,td}

    // ===== utils =====
    function cellId(r,c){ return `${r}-${c}`; }
    function pad2(n){ return String(n).padStart(2,"0"); }

    function getData(themeKey=currentThemeKey){
      try { return JSON.parse(localStorage.getItem(dataKey(themeKey)) || "{}"); }
      catch { return {}; }
    }
    function setData(obj, themeKey=currentThemeKey){
      localStorage.setItem(dataKey(themeKey), JSON.stringify(obj));
    }

    function fmtKoreanDate(d){
      const m = d.getMonth()+1;
      const day = d.getDate();
      return `${m}월 ${day}일`;
    }

    // Monday(월요일) 기준으로 한 주 시작 계산
    function getMondayFromDate(d){
      const date = new Date(d);
      const dow = (date.getDay() + 6) % 7; // Mon=0
      date.setDate(date.getDate() - dow);
      date.setHours(0,0,0,0);
      return date;
    }

    // ISO week -> Monday date
    function isoWeekToMonday(weekStr){
      const [yPart, wPart] = weekStr.split("-W");
      const year = Number(yPart);
      const week = Number(wPart);

      const jan4 = new Date(year, 0, 4);
      const dayOfWeek = (jan4.getDay() + 6) % 7;
      const mondayWeek1 = new Date(jan4);
      mondayWeek1.setDate(jan4.getDate() - dayOfWeek);

      const monday = new Date(mondayWeek1);
      monday.setDate(mondayWeek1.getDate() + (week - 1) * 7);
      monday.setHours(0,0,0,0);
      return monday;
    }

    // 월 몇 주(간단 일관 버전)
    function monthWeekLabel(monday){
      const month = monday.getMonth();
      const firstDay = new Date(monday.getFullYear(), month, 1);
      const firstMonday = getMondayFromDate(firstDay);
      const diffDays = Math.round((monday - firstMonday) / (1000*60*60*24));
      const weekNo = Math.floor(diffDays / 7) + 1;
      return `${month+1}월 ${weekNo}주`;
    }

    // ===== grid =====
    function renderGrid(){
      rowsEl.innerHTML = times.map((t, r) => `
        <tr>
          <td class="time">${t}</td>
          ${Array.from({length:7}).map((_, c) =>
            `<td class="cell empty" data-r="${r}" data-c="${c}"><div class="preview"></div></td>`
          ).join("")}
        </tr>
      `).join("");
    }
    renderGrid();

    function updateCellDisplay(td, value){
      td.querySelector(".preview").textContent = value || "";
      td.classList.toggle("empty", !value || value.trim()==="");
    }

    function loadAllCells(){
      const data = getData(currentThemeKey);
      document.querySelectorAll("td.cell").forEach(td=>{
        const r = td.dataset.r, c = td.dataset.c;
        updateCellDisplay(td, data[cellId(r,c)] || "");
      });
    }

    function saveCellValue(r,c,value){
      const data = getData(currentThemeKey);
      const id = cellId(r,c);
      const v = (value ?? "").replace(/\s+$/,"");
      if(v.trim()==="") delete data[id];
      else data[id] = v;
      setData(data, currentThemeKey);

      const td = document.querySelector(`td.cell[data-r="${r}"][data-c="${c}"]`);
      if(td) updateCellDisplay(td, v);
    }

    // ===== theme =====
    function applyTheme(themeKey){
      const t = THEMES.find(x => x.key === themeKey) || THEMES[0];
      currentThemeKey = t.key;

      document.documentElement.style.setProperty("--bg", t.bg);
      document.documentElement.style.setProperty("--border", t.border);
      document.documentElement.style.setProperty("--header", t.header);
      document.documentElement.style.setProperty("--timebg", t.timebg);

      [...themeBar.querySelectorAll(".theme-btn")].forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.key === t.key);
      });

      localStorage.setItem(STORAGE_THEME_KEY, t.key);
      loadAllCells();
    }

    themeBar.innerHTML = THEMES.map(t => `
      <button class="theme-btn" type="button" data-key="${t.key}">${t.name}</button>
    `).join("");

    themeBar.addEventListener("click", (e)=>{
      const btn = e.target.closest(".theme-btn");
      if(!btn) return;
      applyTheme(btn.dataset.key);
    });

    // ===== memo modal =====
    function openMemo(td){
      const r = Number(td.dataset.r);
      const c = Number(td.dataset.c);
      activeCell = { r, c, td };

      const data = getData(currentThemeKey);
      const value = data[cellId(r,c)] || "";

      pillTime.textContent = times[r];
      pillDay.textContent = days[c];

      memoText.value = value;
      memoBackdrop.style.display = "flex";
      setTimeout(()=> memoText.focus(), 50);
    }
    function closeMemoModal(){
      memoBackdrop.style.display = "none";
      activeCell = null;
    }
    rowsEl.addEventListener("click", (e)=>{
      const td = e.target.closest("td.cell");
      if(td) openMemo(td);
    });
    saveMemoBtn.addEventListener("click", ()=>{
      if(!activeCell) return;
      saveCellValue(activeCell.r, activeCell.c, memoText.value);
      closeMemoModal();
    });
    clearCellBtn.addEventListener("click", ()=>{
      if(!activeCell) return;
      memoText.value = "";
      saveCellValue(activeCell.r, activeCell.c, "");
      closeMemoModal();
    });
    closeMemo.addEventListener("click", closeMemoModal);
    memoBackdrop.addEventListener("click", (e)=>{
      if(e.target === memoBackdrop) closeMemoModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && memoBackdrop.style.display === "flex"){
        closeMemoModal();
      }
    });

    // ===== switches UI helper =====
    function setSwitchVisual(wrapper, checked){
      wrapper.classList.toggle("on", checked);
    }

    // ===== title show/hide =====
    function setTitleVisible(show){
      titleArea.classList.toggle("show", show);
      titleToggle.checked = show;
      setSwitchVisual(titleSwitch, show);
      localStorage.setItem(STORAGE_TITLE_SHOW_KEY, show ? "1" : "0");
    }

    // 기본값: 제목 숨김(OFF) — 원하면 여기 true로 바꾸면 기본 ON
    const defaultTitleShow = false;

    function initTitle(){
      const savedTitle = localStorage.getItem(STORAGE_TITLE_KEY) || "";
      titleInput.value = savedTitle;
      plannerTitleText.textContent = savedTitle || "주간 플래너";
      plannerMetaText.textContent = "";

      const show = (localStorage.getItem(STORAGE_TITLE_SHOW_KEY) ?? (defaultTitleShow ? "1":"0")) === "1";
      setTitleVisible(show);
    }

    titleInput.addEventListener("input", ()=>{
      localStorage.setItem(STORAGE_TITLE_KEY, titleInput.value);
      plannerTitleText.textContent = titleInput.value || "주간 플래너";
    });

    titleSwitch.addEventListener("click", ()=>{
      setTitleVisible(!titleToggle.checked);
    });

    // ===== date link =====
    function setDateToolsVisible(show){
      dateTools.classList.toggle("show", show);
    }

    function clearHeaderDates(){
      document.querySelectorAll(".date[data-dow]").forEach(el => el.textContent = "");
      weekRangeText.textContent = "";
    }

    function applyWeekMonday(monday){
      const start = new Date(monday);
      const end = new Date(monday); end.setDate(monday.getDate()+6);

      // 요일 옆 날짜
      document.querySelectorAll(".date[data-dow]").forEach(el=>{
        const i = Number(el.dataset.dow);
        const d = new Date(monday);
        d.setDate(monday.getDate()+i);
        el.textContent = `(${fmtKoreanDate(d)})`;
      });

      weekRangeText.textContent = `${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)}`;

      // 제목 자동 생성: 사용자가 제목을 직접 입력하지 않았을 때만
      const custom = (localStorage.getItem(STORAGE_TITLE_KEY) || "").trim();
      const autoTitle = `${monthWeekLabel(monday)} 플래너(${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)})`;

      if(!custom){
        plannerTitleText.textContent = autoTitle;
        titleInput.value = autoTitle;
      }
      plannerMetaText.textContent = `기간: ${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)}`;
    }

    function enableDateLink(enable){
      dateLinkToggle.checked = enable;
      setSwitchVisual(dateSwitch, enable);
      localStorage.setItem(STORAGE_DATE_LINK_KEY, enable ? "1" : "0");
      setDateToolsVisible(enable);

      if(!enable){
        clearHeaderDates();
        plannerMetaText.textContent = "";
        return;
      }

      // 저장된 week가 있으면 우선 적용
      const weekStr = localStorage.getItem(STORAGE_WEEK_KEY);
      if(weekStr){
        weekPicker.value = weekStr;
        const monday = isoWeekToMonday(weekStr);
        applyWeekMonday(monday);
      }else{
        // 없으면 오늘 기준으로 주 자동 적용
        const monday = getMondayFromDate(new Date());
        applyWeekMonday(monday);
      }
    }

    // week 선택(지원되는 브라우저)
    weekPicker.addEventListener("change", ()=>{
      if(!weekPicker.value) return;
      localStorage.setItem(STORAGE_WEEK_KEY, weekPicker.value);
      const monday = isoWeekToMonday(weekPicker.value);
      applyWeekMonday(monday);
    });

    // date 선택(모든 브라우저 대안)
    datePicker.addEventListener("change", ()=>{
      if(!datePicker.value) return;
      const d = new Date(datePicker.value + "T00:00:00");
      const monday = getMondayFromDate(d);
      // week 저장은 ISO week로 정확히 만들기 까다로워서(표준/계산 필요)
      // 여기서는 week 저장 대신, 그냥 적용만 함.
      applyWeekMonday(monday);
    });

    // 토글 클릭
    dateSwitch.addEventListener("click", ()=>{
      enableDateLink(!dateLinkToggle.checked);
    });

    function initDateLink(){
      const enabled = localStorage.getItem(STORAGE_DATE_LINK_KEY) === "1";
      enableDateLink(enabled);
    }

    // ===== print orientation =====
    function applyOrientation(value){
      document.documentElement.style.setProperty("--paper", value);
      localStorage.setItem(STORAGE_ORIENTATION_KEY, value);
    }
    orientationSelect.addEventListener("change", ()=>{
      applyOrientation(orientationSelect.value);
    });
    function initOrientation(){
      const saved = localStorage.getItem(STORAGE_ORIENTATION_KEY) || "portrait";
      orientationSelect.value = saved;
      applyOrientation(saved);
    }

    // ===== notice =====
    document.getElementById("noticeBtn").addEventListener("click", ()=>{
      alert("준비중");
    });

    // ===== print =====
    document.getElementById("printBtn").addEventListener("click", ()=>{
      alert("색상이 그대로 나오려면 인쇄 설정에서 '배경 그래픽(배경색/이미지)'을 켜야 해.\n(브라우저가 자동으로 켤 수는 없어!)");
      window.print();
    });

    // ===== clear theme =====
    document.getElementById("clearBtn").addEventListener("click", ()=>{
      const ok = confirm("현재 선택한 테마의 입력 내용을 모두 지울까요?");
      if(!ok) return;
      localStorage.removeItem(dataKey(currentThemeKey));
      loadAllCells();
    });

    // ===== export/import =====
    exportBtn.addEventListener("click", ()=>{
      const payload = {
        app: "pasteltone-weekly-planner",
        version: 3,
        exportedAt: new Date().toISOString(),
        currentTheme: currentThemeKey,
        settings: {
          title: localStorage.getItem(STORAGE_TITLE_KEY) || "",
          titleShow: localStorage.getItem(STORAGE_TITLE_SHOW_KEY) || "0",
          dateLinkEnabled: localStorage.getItem(STORAGE_DATE_LINK_KEY) || "0",
          selectedWeek: localStorage.getItem(STORAGE_WEEK_KEY) || "",
          orientation: localStorage.getItem(STORAGE_ORIENTATION_KEY) || "portrait",
        },
        dataByTheme: {}
      };
      for(const t of THEMES){
        payload.dataByTheme[t.key] = getData(t.key);
      }
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date();
      a.href = url;
      a.download = `weekly_planner_backup_${date.getFullYear()}${pad2(date.getMonth()+1)}${pad2(date.getDate())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", ()=>{
      importFile.value = "";
      importFile.click();
    });

    importFile.addEventListener("change", async ()=>{
      const file = importFile.files?.[0];
      if(!file) return;

      try{
        const text = await file.text();
        const json = JSON.parse(text);

        if(!json || typeof json !== "object" || !json.dataByTheme){
          alert("형식이 올바르지 않은 JSON이야.");
          return;
        }

        const ok = confirm("가져오면 현재 저장된 내용이 덮어쓰기될 수 있어. 진행할까?");
        if(!ok) return;

        for(const t of THEMES){
          const incoming = json.dataByTheme[t.key];
          if(incoming && typeof incoming === "object"){
            setData(incoming, t.key);
          }
        }

        if(json.settings){
          localStorage.setItem(STORAGE_TITLE_KEY, json.settings.title || "");
          localStorage.setItem(STORAGE_TITLE_SHOW_KEY, json.settings.titleShow || "0");
          localStorage.setItem(STORAGE_DATE_LINK_KEY, json.settings.dateLinkEnabled || "0");
          localStorage.setItem(STORAGE_WEEK_KEY, json.settings.selectedWeek || "");
          localStorage.setItem(STORAGE_ORIENTATION_KEY, json.settings.orientation || "portrait");
        }

        initTitle();
        initOrientation();
        initDateLink();

        const themeToApply = (json.currentTheme && THEMES.some(x=>x.key===json.currentTheme))
          ? json.currentTheme : currentThemeKey;

        applyTheme(themeToApply);

        alert("가져오기 완료!");
      }catch(err){
        alert("가져오기 실패! 파일이 손상됐거나 JSON이 아니야.");
      }
    });

    // ===== init =====
    initTitle();
    initOrientation();
    initDateLink();
    applyTheme(localStorage.getItem(STORAGE_THEME_KEY) || "pink");
  </script>
</body>
</html>
